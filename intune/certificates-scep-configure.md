---
title: "Intune で SCEP 証明書を構成して管理する"
titlesuffix: Azure portal
description: "インフラストラクチャを構成してから、Intune SCEP 証明書プロファイルを作成して割り当てる方法について説明します。\""
keywords: 
author: arob98
ms.author: angrobe
manager: angrobe
ms.date: 12/09/2017
ms.topic: article
ms.prod: 
ms.service: microsoft-intune
ms.technology: 
ms.assetid: d567d85f-e4ee-458e-bef7-6e275467efce
ms.reviewer: kmyrup
ms.suite: ems
ms.custom: intune-azure
ms.openlocfilehash: db02c54096ccb09d24f312566def36c24f9e687b
ms.sourcegitcommit: 2459bfda07a2afd2cfcd94a1972a3fb2e565ce8d
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 01/22/2018
---
# <a name="configure-and-manage-scep-certificates-with-intune"></a>Intune で SCEP 証明書を構成して管理する
[!INCLUDE [azure_portal](./includes/azure_portal.md)]

このトピックでは、インフラストラクチャを構成してから、Intune で SCEP (Simple Certificate Enrollment Protocol) 証明書プロファイルを作成して割り当てる方法について説明します。

## <a name="configure-on-premises-infrastructure"></a>オンプレミス インフラストラクチャを構成する

- **Active Directory ドメイン**: このセクションで示されているすべてのサーバー (Web アプリケーション プロキシ サーバーを除く) は、Active Directory ドメインに参加する必要があります。

- **証明機関** (CA): Windows Server 2008 R2 以降の Enterprise エディションで実行するエンタープライズ証明機関 (CA) が必要です。 スタンドアロン CA はサポートされません。 詳細については、「[Install the Certification Authority (証明機関のインストール)](http://technet.microsoft.com/library/jj125375.aspx)」をご覧ください。
   CA が Windows Server 2008 R2 を搭載している場合は、 [KB2483564 の修正プログラムをインストール](http://support.microsoft.com/kb/2483564/)する必要があります。

- **NDES サーバー**: Windows Server 2012 R2 以降を実行しているサーバーに、ネットワーク デバイス登録サービス (NDES) を設定する必要があります。 エンタープライズ CA も実行しているサーバーで Intune を実行する場合には、ネットワーク デバイス登録サービスは使用できません。 ネットワーク デバイス登録サービスをホストするための Windows Server 2012 R2 の構成方法については、「[ネットワーク デバイス登録サービスのガイダンス](http://technet.microsoft.com/library/hh831498.aspx)」を参照してください。
  NDES サーバーは、CA をホストしているドメインに参加する必要があります。CA と同じサーバーに置くことはできません。 別個のフォレスト、分離ネットワーク、内部ドメインで NDES サーバーを展開する方法については、「[ポリシー モジュールとネットワーク デバイス登録サービスの使用](https://technet.microsoft.com/library/dn473016.aspx)」を参照してください。

- **Microsoft Intune Certificate Connector**: Azure Portal を使用して **Certificate Connector** インストーラー (**ndesconnectorssetup.exe**) をダウンロードします。 これにより、証明書コネクタをインストールするコンピューターで **ndesconnectorssetup.exe** を実行できます。 
- **Web アプリケーション プロキシ サーバー** (省略可能): Web アプリケーション プロキシ (WAP) サーバーとして Windows Server 2012 R2 以降を実行しているサーバーを使用します。 この構成は:
   -  デバイスはインターネット接続を使用して証明書を受信できます。
   -  デバイスがインターネット接続経由で証明書を受信して更新する場合のセキュリティ推奨事項です。

  > [!NOTE]           
  > -    WAP をホストするサーバーは、ネットワーク デバイス登録サービスで使用される長い URL のサポートを有効にする [更新プログラムをインストールする](http://blogs.technet.com/b/ems/archive/2014/12/11/hotfix-large-uri-request-in-web-application-proxy-on-windows-server-2012-r2.aspx) 必要があります。 この更新プログラムは、 [2014 年 12 月の更新プログラムのロールアップ](http://support.microsoft.com/kb/3013769)に含まれます。または、 [KB3011135](http://support.microsoft.com/kb/3011135)から個別に入手できます。
  >-  また、WAP をホストするサーバーが、外部クライアントに公開される名前と一致する SSL 証明書を持ち、NDES サーバーで使用される SSL 証明書を信頼する必要があります。 これらの証明書を使用すると、WAP サーバーはクライアントからの SSL 接続を終了し、NDES サーバーへの新しい SSL 接続を作成できます。
   WAP の証明書については、「[内部アプリケーションの公開のために Web アプリケーション プロキシをインストールおよび構成する](https://technet.microsoft.com/library/dn383650.aspx)」の**証明書の計画**に関するセクションを参照してください。 WAP サーバーの一般的な情報については、「[Web アプリケーション プロキシの使用](http://technet.microsoft.com/library/dn584113.aspx)」を参照してください。|

### <a name="network-requirements"></a>ネットワークの要件

インターネットから境界ネットワークまでを範囲として、インターネット上のあらゆるホスト/IP アドレスから NDES サーバーへの送信にポート 443 を割り当てます。

境界ネットワークから信頼されたネットワークまでを範囲として、ドメイン参加 NDES サーバーのドメイン アクセスに必要なすべてのポートとプロトコルを割り当てます。 NDES サーバーは、証明書サーバー、DNS サーバー、構成マネージャー サーバー、ドメイン コントローラーへのアクセス許可を必要とします。

NDES サーバーは、[Azure AD アプリケーション プロキシ](https://azure.microsoft.com/documentation/articles/active-directory-application-proxy-publish/)、[Web アクセス プロキシ](https://technet.microsoft.com/library/dn584107.aspx)、サード パーティ製のプロキシなどのプロキシを通じて公開することをお勧めします。


### <a name="certificates-and-templates"></a>証明書とテンプレート

|オブジェクト|説明|
|----------|-----------|
|**証明書テンプレート**|発行元 CA でこのテンプレートを構成します。|
|**クライアント認証証明書**|発行元 CA またはパブリック CA から要求されます。この証明書を NDES サーバーにインストールします。|
|**サーバー認証証明書**|発行元 CA またはパブリック CA から要求されます。この SSL 証明書をインストールし NDES サーバーの IIS にバインドします。|
|**信頼されたルート CA 証明書**|この証明書をルート CA またはルート CA を信頼するデバイスから **.cer** ファイルとしてエクスポートし、信頼された CA 証明書プロファイルを使用してデバイスに割り当てます。<br /><br />オペレーティング システムのプラットフォームごとに 1 つの信頼されたルート CA 証明書を使用し、作成する各信頼されたルート証明書プロファイルに関連付けます。<br /><br />必要に応じて、信頼されたルート CA 証明書を追加して使用できます。 ルート CA 証明書を追加する局面としては、Wi-Fi アクセス ポイント用のサーバー認証証明書に署名する CA の信頼性を担保する必要がある場合などが考えられます。|

### <a name="accounts"></a>[アカウント]

|名前|説明|
|--------|-----------|
|**NDES サービス アカウント**|NDES サービス アカウントとして使用するドメイン ユーザー アカウントを指定します。|

## <a name="configure-your-infrastructure"></a>インフラストラクチャを構成する
証明書プロファイルを構成する前に、次のタスクを行う必要があります。これには、Windows Server 2012 R2 および Active Directory 証明書サービス (ADCS) の知識が必要です。

**手順 1**: NDES サービス アカウントを作成する

**手順 2**: 証明機関で証明書テンプレートを構成する

**手順 3**: NDES サーバーで前提条件を構成する

**手順 4**: Intune で使用するための NDES を構成する

**手順 5**: Intune Certificate Connector を有効にし、インストールし、構成する

#### <a name="step-1---create-an-ndes-service-account"></a>手順 1 - NDES サービス アカウントを作成する

NDES サービス アカウントとして使用するドメイン ユーザー アカウントを作成します。 NDES をインストールして構成する前に、発行元 CA でテンプレートを構成するときに、このアカウントを指定します。 既定の権限である、**ローカル ログオン**、**サービスとしてログオン**、**バッチ ジョブとしてログオン**などの権限がユーザーに付与されていることを確認します。 ポリシーを強化し、これらの権限を無効にしている組織もあります。

#### <a name="step-2---configure-certificate-templates-on-the-certification-authority"></a>手順 2 - 証明機関で証明書テンプレートを構成する
このタスクでは次のことを行います。

-   NDES の証明書テンプレートを構成します

-   NDES に証明書テンプレートを発行します

##### <a name="to-configure-the-certification-authority"></a>証明機関を構成するには

1.  エンタープライズ管理者としてログオンします。

2.  発行元 CA で、証明書テンプレート スナップインを使用して、新しいカスタム テンプレートを作成するか、または既存のテンプレートをコピーして NDES で使用するために (ユーザー テンプレートのように) 既存のテンプレートを編集します。

    >[!NOTE]
    > NDES 証明書テンプレートは、v2 証明書テンプレートを基盤とする必要があります (Windows 2003 の互換性あり)。

    テンプレートには次の構成が必要です。

    -   テンプレートのわかりやすい **テンプレート表示名** を指定します。

    -   **[サブジェクト名]** タブで **[要求に含まれる]** を選択します (セキュリティが NDES の Intune ポリシー モジュールによって適用されます)。

    -   **[拡張]** タブで、**[アプリケーション ポリシーの説明]** に **[クライアント認証]** が含まれることを確認します。

        > [!IMPORTANT]
        > iOS および macOS の証明書テンプレートの場合、**[拡張]** タブで、**[キー使用法]** を編集し、**[署名は発行元の証明である]** がオンになっていないことを確認します。

    -   **[セキュリティ]** タブで、NDES サービス アカウントを追加し、テンプレートへの **[登録]** アクセス許可を付与します。 SCEP プロファイルを作成する Intune 管理者は、SCEP プロファイルの作成時にテンプレートを閲覧できるように、**読み取り**権限を必要とします。

    > [!NOTE]
    > 証明書を失効させるには、証明書プロファイルで使用されている証明書テンプレートごとに*証明書の発行および管理*の権限が NDES サービス アカウントに必要です。

3.  **[一般]** タブでテンプレートの **[有効期間]** を確認します。 既定では、Intune はテンプレートで構成されている値を使用します。 ただし、要求元が異なる値を指定できるように CA を構成できます。異なる値は、Intune 管理者コンソールから設定できます。 常にテンプレートの値を使用する場合は、この手順の残りの部分をスキップします。

    > [!IMPORTANT]
    > iOS および macOS は、他の構成に関係なく、常にテンプレートで設定される値を使用します。

次は、サンプル テンプレート構成のスクリーンショットです。

![テンプレート、[要求処理] タブ](.\media\scep_ndes_request_handling.png)

![テンプレート、[サブジェクト名] タブ](.\media\scep_ndes_subject_name.jpg)

![テンプレート、[セキュリティ] タブ](.\media\scep_ndes_security.jpg)

![テンプレート、[拡張] タブ](.\media\scep_ndes_extensions.jpg)

![テンプレート、[発行要件] タブ](.\media\scep_ndes_issuance_reqs.jpg)

> [!IMPORTANT]
> アプリケーション ポリシーの場合、必要なアプリケーション ポリシーのみを追加します。 セキュリティ管理者の選択を確定します。



要求元が有効期間を指定できるように CA を構成するには、

1. CA で次のコマンドを実行します。
    - **certutil -setreg Policy\EditFlags +EDITF_ATTRIBUTEENDDATE**
    - **net stop certsvc**
    - **net start certsvc**
2. 発行元 CA で、証明機関スナップインを使用して証明書テンプレートを発行します。
    **[証明書テンプレート]** ノードを選択し、**[アクション]** -&gt; **[新規]** &gt; **[発行する証明書テンプレート]** の順にクリックして、手順 2. で作成したテンプレートを選択します。
3. **[証明書テンプレート]** フォルダーに表示されることで、テンプレートが発行されたことを確認します。


#### <a name="step-3---configure-prerequisites-on-the-ndes-server"></a>手順 3 - NDES サーバーで前提条件を構成する
このタスクでは次のことを行います。

-   Windows サーバーに NDES を追加し、NDES をサポートするように IIS を構成する

-   NDES サービス アカウントを IIS_IUSR グループに追加します

-   NDES サービス アカウントの SPN を設定します




1. NDES をホストするサーバーに**エンタープライズ管理者**としてログインし、[役割と機能の追加ウィザード](https://technet.microsoft.com/library/hh831809.aspx)を使用して NDES をインストールします。

   1. ウィザードで、**[Active Directory 証明書サービス]** を選択して AD CS 役割サービスにアクセスできるようにします。 **[ネットワーク デバイス登録サービス]** をオンにし、**[証明機関]** をオフにして、ウィザードを完了します。

      > [!TIP]
      > ウィザードの **[インストールの進行状況]** ページでは、**[閉じる]** をクリックしないでください。 代わりに、**[対象サーバーに Active Directory 証明書サービスを構成する]** のリンクをクリックします。 これにより、次のタスクで使用する **[AD CS の構成]** ウィザードが開きます。 [AD CS の構成] が開いた後は、役割と機能の追加ウィザードを閉じてかまいません。

   2. NDES がサーバーに追加されるときに、ウィザードは IIS もインストールします。 IIS が次の構成であることを確認します。

      -   **[Web サーバー]** &gt; **[セキュリティ]** &gt; **[要求のフィルタリング]**

      -   **[Web サーバー]** &gt; **[アプリケーション開発]** &gt; **[ASP.NET 3.5]**。 ASP.NET 3.5 をインストールすると、.NET Framework 3.5 がインストールされます。 .NET Framework 3.5 をインストールするとき、**[.NET Framework 3.5]** のコア機能および **[HTTP アクティブ化]** の両方をインストールします。

      -   **[Web サーバー]** &gt; **[アプリケーション開発]** &gt; **[ASP.NET 4.5]**。 ASP.NET 4.5 をインストールすると、.NET Framework 4.5 がインストールされます。 .NET Framework 4.5 をインストールする際に、**[.NET Framework 4.5]** のコア機能、**[ASP.NET 4.5]**、および **[WCF サービス]** &gt; **[HTTP アクティブ化]** 機能をインストールします。

      -   **[管理ツール]** &gt; **[IIS 6 と互換性のある管理]** &gt; **[IIS 6 メタベース互換]**

      -   **[管理ツール]** &gt; **[IIS 6 と互換性のある管理]** &gt; **[IIS 6 WMI 互換性]**

   3. サーバーで、**IIS_IUSR** グループのメンバーとして NDES サービス アカウントを追加します。

2. 管理者特権のコマンド プロンプトで、次のコマンドを実行して、NDES サービス アカウントの SPN を設定します。

`**setspn -s http/&lt;DNS name of NDES Server&gt; &lt;Domain name&gt;\&lt;NDES Service account name&gt;**`

   たとえば、NDES サーバーの名前が **Server01**、ドメインが **Contoso.com**、サービス アカウントが **NDESService**の場合は、次のようになります。

`**setspn –s http/Server01.contoso.com contoso\NDESService**`

#### <a name="step-4---configure-ndes-for-use-with-intune"></a>手順 4 - Intune で使用するための NDES を構成する
このタスクでは次のことを行います。

-   発行元 CA で使用するための NDES を構成する

-   IIS でサーバー認証 (SSL) 証明書をバインドします

-   IIS で要求フィルター処理を構成します


1. NDES サーバーで AD CS 構成ウィザードを開き、次の構成を行います。

   > [!TIP]
   > 前のタスクでリンクをクリックした場合、このウィザードは既に開いています。 それ以外の場合、サーバー マネージャーを開いて Active Directory 証明書サービスの展開後構成にアクセスします。

   -   **[役割サービス]** ページで、**[ネットワーク デバイス登録サービス]** を選択します。

   -   **[NDES のサービス アカウント]** ページで、NDES サービス アカウントを指定します。

   -   **[NDES 用の CA]** ページで、**[選択]** をクリックし、証明書テンプレートを構成した発行元 CA を選択します。

   -   **[NDES の暗号化]** ページで、会社の要件を満たすキーの長さを設定します。

   **[確認]** ページで、**[構成]** をクリックしてウィザードを完了します。

2. ウィザードが完了した後、NDES サーバーで次のレジストリ キーを編集します。

   - <strong>\Software\microsoft\cryptography\mscep\</strong >

   このキーを編集するには、**[要求の処理]** タブで証明書テンプレートの **[目的]** を確認し、既存のデータを、タスク 1 で指定した (テンプレートの表示名ではなく) 証明書テンプレートの名前に置き換えることによって、レジストリの対応するエントリを編集します。 次の表では、証明書テンプレートの目的とレジストリの値の対応を示します。


   | 証明書テンプレートの目的 ([要求の処理] タブ) | 編集するレジストリ値 | SCEP プロファイルについて Intune 管理コンソールに表示される値 |
   |------------------------------------------------------------|------------------------|-------------------------------------------------------------|
   |                         署名                          |   SignatureTemplate    |                      デジタル署名                      |
   |                         暗号化                         |   EncryptionTemplate   |                      キーの暗号化                       |
   |                  署名と暗号化                  | GeneralPurposeTemplate |        キーの暗号化<br /><br />デジタル署名        |

   たとえば、証明書テンプレートの目的が **[暗号化]** の場合、 **EncryptionTemplate** の値を証明書テンプレートの名前に編集します。

3. NDES サーバーは、長い URL (クエリ) を受け取ります。2 つのレジストリ エントリを追加する必要があります。

    |場所|値|型|データ|
    |-------|-----|----|----|
    |HKLM\SYSTEM\CurrentControlSet\Services\HTTP\Parameters|MaxFieldLength|DWORD|65534 (10 進数)|
    |HKLM\SYSTEM\CurrentControlSet\Services\HTTP\Parameters|MaxRequestBytes|DWORD|65534 (10 進数)|


4. IIS マネージャーで、**[既定の Web サイト]**  ->  **[要求のフィルタリング]**  ->  **[機能設定の編集]** の順に選択し、**[URL の最大長]** と **[クエリ文字列の最大長]** を図のように *65534* に変更します。

    ![IIS の URL とクエリの最大長](.\media\SCEP_IIS_max_URL.png)

5. サーバーを再起動します。 サーバーで実行されている **iisreset** は、これらの変更をファイナライズするために十分ではないでしょう。
6. http://<em>FQDN</em>/certsrv/mscep/mscep.dll に移動します。 次のような NDES ページが表示されるはずです。

    ![NDES のテスト](.\media\SCEP_NDES_URL.png)

    「**503 サービスを利用できません**」が表示された場合、イベント ビューアを確認します。 おそらくは、NDES ユーザーに権限がないため、アプリケーション プールが停止しているでしょう。 それらの権限に関する説明はタスク 1 にあります。

##### <a name="to-install-and-bind-certificates-on-the-ndes-server"></a>NDES サーバーで証明書をインストールしてバインドするには

1.  NDES サーバーで、内部 CA またはパブリック CA に **サーバー認証** 証明書を要求してインストールします。 その後、この SSL 証明書を IIS でバインドします。

    > [!TIP]
    > IIS で SSL 証明書をバインドした後、クライアント認証証明書をインストールします。 この証明書は、NDES サーバーによって信頼されている CA によって発行できます。 最善の方法ではありませんが、証明書にサーバーとクライアント両方の EKU (Enhance Key Usage) がある場合は、同じ証明書をサーバー認証とクライアント認証の両方に使用できます。 これらの認証証明書については、次の手順を確認してください。

    1.  サーバー認証証明書を取得した後、 **IIS マネージャー**を開き、**[接続]** ウィンドウで **[既定の Web サイト]** を選択し、**[操作]** ウィンドウの **[バインド]** をクリックします。

    2.  **[追加]** をクリックし、**[種類]** を **[https]** に設定して、ポートが **443**であることを確認します (スタンドアロン Intune の場合はポート 443 のみがサポートされます)。

    3.  **[SSL 証明書]** で、サーバー認証証明書を指定します。

        > [!NOTE]
        > NDES サーバーが 1 つのネットワーク アドレスに対して外部名と内部名の両方を使用している場合、サーバー認証証明書の **[サブジェクト名]** は外部パブリック サーバー名、**[サブジェクトの別名]** は内部サーバー名である必要があります。

2.  NDES サーバーで、内部 CA またはパブリック CA に **クライアント認証** 証明書を要求してインストールします。 証明書に両方の機能がある場合、これはサーバー認証証明書と同じ証明書でもかまいません。

    クライアント認証証明書には次のプロパティが必要です。

    **[拡張キー使用法]** - **[クライアント認証]** を含む必要があります。

    **[サブジェクト名]** - 証明書をインストールするサーバー (NDES サーバー) の DNS 名と同じである必要があります。

##### <a name="to-configure-iis-request-filtering"></a>IIS 要求フィルタリングを構成するには

1.  NDES サーバーで **IIS マネージャー**を開き、**[接続]** ウィンドウの **[既定の Web サイト]** を選択し、**[要求のフィルタリング]** を開きます。

2.  **[機能設定の編集]** をクリックし、次のように値を設定します。

    **[クエリ文字列の最大長 (バイト)]** = **65534**

    **URL の最大長 (バイト)** = **65534**

3.  次のレジストリ キーを確認します。

    **HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\HTTP\Parameters**

    次の値が DWORD エントリとして設定されていることを確認します。

    名前: **MaxFieldLength**、10 進数値 **65534**

    名前: **MaxRequestBytes**、10 進数値 **65534**

4. NDES サーバーを再起動します。 サーバーは証明書コネクタをサポートする準備ができました。

#### <a name="step-5---enable-install-and-configure-the-intune-certificate-connector"></a>手順 5 - Intune Certificate Connector を有効にし、インストールし、構成する
このタスクでは次のことを行います。

- Intune で NDES のサポートを有効にします。
- 自分の環境のサーバーで証明書コネクタをダウンロードし、インストールして、構成します。 高可用性をサポートするために、さまざまなサーバーに複数の証明書コネクタをインストールすることができます。

##### <a name="to-download-install-and-configure-the-certificate-connector"></a>証明書コネクタをダウンロードし、インストールして、構成するには
![ConnectorDownload](./media/certificates-download-connector.png)   

1. Azure Portal にサインインします。 
2. **[その他のサービス]**  >  **[監視 + 管理]**  >  **[Intune]** の順に選択します。
3. **[Intune]** ブレードで、**[デバイス構成]** を選択します。
4. **[デバイス構成]** ブレードで **[証明機関]** を選択します。
5. **[追加]** をクリックして、**[Download Connector file]\(コネクタ ファイルのダウンロード\)** を選択します。 インストールするサーバーからアクセスできる場所にダウンロードしたものを保存します。 
6.  ダウンロードが完了したら、ダウンロードしたインストーラー (**ndesconnectorssetup.exe**) を Windows Server 2012 R2 サーバーで実行します。 インストーラーは、NDES のポリシー モジュールと CRP Web サービスもインストールします。 (CRP Web サービス CertificateRegistrationSvc は IIS のアプリケーションとして実行されます)。

    > [!NOTE]
    > スタンドアロン Intune の NDES をインストールする場合、CRP サービスは証明書コネクタと共に自動的にインストールされます。 構成マネージャーで Intune を使用する場合は、証明書登録ポイントを別のサイト システムの役割としてインストールします。

3.  証明書コネクタのクライアント証明書の入力を求められたら、**[選択]** を選択し、タスク 3 で NDES サーバーにインストールした**クライアント認証**証明書を選択します。

    クライアント認証証明書を選択した後、**[Microsoft Intune 証明書コネクタのクライアント証明書]** 画面に戻ります。 選択した証明書は表示されませんが、**[次へ]** をクリックしてその証明書のプロパティを表示します。 次に、**[次へ]** をクリックし、**[インストール]** をクリックします。

4.  ウィザードが完了した後、ウィザードを閉じる前に、**[証明書コネクタの UI を起動]** をクリックします。

    > [!TIP]
    > 証明書コネクタの UI を起動する前にウィザードを閉じた場合は、次のコマンドを実行して再び開くことができます。
    >
    > **&lt;install_Path&gt;\NDESConnectorUI\NDESConnectorUI.exe**

5.  **証明書コネクタ** UI で:

    **[サインイン]** をクリックし、Intune サービス管理者の資格情報、またはグローバル管理アクセス許可を持つテナント管理者の資格情報を入力します。

    組織でプロキシ サーバーを使用していて、NDES サーバーがインターネットにアクセスするためにプロキシが必要な場合は、**[プロキシ サーバーを使用する]** をクリックし、接続するためのプロキシ サーバーの名前、ポート、およびアカウント資格情報を指定します。

    **[詳細設定]** タブを選択し、発行元 CA で **証明書の発行と管理** アクセス許可を持つアカウントの資格情報を指定して、**[適用]** をクリックします。

    これで、証明書コネクタ UI を閉じることができます。

6.  コマンド プロンプトを開き、「**services.msc**」と入力して **Enter** キーを押し、**Intune Connector Service** を右クリックして **[再起動]** をクリックします。

サービスが実行していることを確認するには、ブラウザーを開き、次の URL を入力します。 **403** エラーが返る必要があります。

**http:// &lt;FQDN_of_your_NDES_server&gt;/certsrv/mscep/mscep.dll**

## <a name="how-to-create-a-scep-certificate-profile"></a>SCEP 証明書プロファイルを作成する方法

1. Azure Portal で、**[デバイスの構成]** ワークロードを選択します。
2. **[デバイス構成]** ブレードで、**[管理]** > **[プロファイル]** の順に選択します。
3. [プロファイル] ブレードで、**[プロファイルの作成]** を選択します。
4. **[プロファイルを作成します]** ブレードで、SCEP 証明書プロファイルの**名前**と**説明**を入力します。
5. **[プラットフォーム]** ドロップダウン リストで、この SCEP 証明書のデバイス プラットフォームを選択します。 現時点では、デバイスの制限設定に対応している次のいずれかのプラットフォームを選択できます。
    - **Android**
    - **Android**
    - **macOS**
    - **Windows Phone 8.1**
    - **Windows 8.1 以降**
    - **Windows 10 以降**
6. **[プロファイルの種類]** ドロップダウン リストで、**[SCEP 証明書]** を選択します。
7. **[SCEP 証明書]** ブレードで、次の設定を構成します。
    - **[証明書の有効期間]** - 発行元 CA で **certutil - setreg Policy\EditFlags +EDITF_ATTRIBUTEENDDATE** コマンドを実行してカスタム有効期間を設定できるようにした場合は、証明書が失効するまでの期間を指定します。<br>指定した証明書テンプレートの有効期限よりも小さい値を指定できますが、大きい値は指定できません。 たとえば、証明書テンプレートで証明書の有効期限が 2 年になっている場合は、この値を 1 年することはできますが、5 年にすることはできません。 また、発行元の CA の証明書の残りの有効期限よりも小さい値を指定する必要があります。 
    - **[キー格納プロバイダー (KSP)]** (Windows Phone 8.1、Windows 8.1、Windows 10) - 証明書のキーを格納する場所を指定します。 次のいずれかの値を選択します。
        - **トラステッド プラットフォーム モジュール (TPM) KSP が存在する場合は TPM KSP に登録する (それ以外はソフトウェア KSP に登録する)**
        - **トラステッド プラットフォーム モジュール (TPM) KSP に登録する (それ以外は失敗)**
        - **Passport に登録する、それ以外は失敗 (Windows 10 以降)**
        - **ソフトウェア KSP に登録する**
    - **[サブジェクト名の形式]** - 一覧から、Intune が証明書要求のサブジェクト名をどのように自動生成するかを指定します。 証明書がユーザー用の場合、サブジェクト名にユーザーのメール アドレスを追加することもできます。 次の中から選択します。
        - **未構成**
        - **共通名**
        - **電子メールを含む共通名**
        - **電子メールとしての共通名**
        - **IMEI (International Mobile Equipment Identity)**
        - **シリアル番号**
        - **カスタム**- このオプションを選択すると、別のドロップダウン フィールドが表示されます。 このフィールドを使用して、カスタムのサブジェクト名の形式を入力します。 カスタム形式でサポートされている 2 つの変数は、**共通名 (CN)** と**電子メール (E)** です。 これらの変数と静的文字列の 1 つ以上の組み合わせを使用することで、**CN={{UserName}},E={{EmailAddress}},OU=Mobile,O=Finance Group,L=Redmond,ST=Washington,C=US** のようなカスタムのサブジェクト名の形式を作成できます。この例では、CN と E 変数に加えて、組織単位、組織、市区町村、州、および国の値の文字列を使用してサブジェクト名形式を作成しています。 [このトピック](https://msdn.microsoft.com/library/windows/desktop/aa377160.aspx)では、**CertStrToName** 関数とこの関数でサポートされる文字列について説明しています。

    - **[サブジェクトの別名]** - Intune が証明書要求のサブジェクトの別名 (SAN) をどのように自動生成するかを指定します。 たとえば、ユーザー証明書の種類を選択した場合は、サブジェクトの別名にユーザー プリンシパル名 (UPN) を含めることができます。 クライアント証明書を Windows ポリシー サーバーでの認証に使用する場合は、サブジェクトの別名を UPN に設定する必要があります。 
    - **[キー使用法]** - 証明書のキー使用法のオプションを指定します。 次のオプションから選択できます。 
        - **キーの暗号化:** キーが暗号化されている場合だけキーを交換できます。 
        - **デジタル署名:** キーがデジタル署名で保護されている場合だけ、キーを交換できます。 
    - **[キー サイズ (ビット)]** - キーに含まれるビット数を選択します。 
    - **[ハッシュ アルゴリズム]** (Android、Windows Phone 8.1、Windows 8.1、Windows 10) - この証明書で使用するハッシュ アルゴリズムの種類を 1 つ選択します。 接続しているデバイスをサポートするセキュリティの最も強力なレベルを選択します。 
    - **[ルート証明書]** - 既に構成してユーザーまたはデバイスに割り当てているルート CA 証明書プロファイルを選択します。 この CA 証明書は、この証明書プロファイルで構成している証明書を発行する CA のルート証明書である必要があります。 
    - **[拡張キー使用法]** - **[追加]** を選択して、証明書の使用目的に対応する値を追加します。 ほとんどの場合、ユーザーまたはデバイスがサーバーに対して認証できるように、証明書には **[クライアント認証]** が必要です。 ただし、必要に応じてその他のキー使用法を追加できます。 
    - **登録設定**
        - **[更新しきい値 (%)]** - 証明書の有効期間の残りがどの程度 (%) になったら、デバイスが更新を要求するかを指定します。
        - **[SCEP サーバーの URL]** - SCEP 経由で証明書を発行する NDES サーバーの URL を 1 つまたは複数指定します。 
8. 完了したら、**[プロファイルを作成します]** ブレードに戻り、**[作成]** をクリックします。

プロファイルが作成され、プロファイルの一覧ブレードに表示されます。

## <a name="how-to-assign-the-certificate-profile"></a>証明書プロファイルを割り当てる方法

証明書プロファイルをグループに割り当てる前に、次の点を考慮します。

- 証明書プロファイルをグループに割り当てるときに、信頼された CA 証明書プロファイルの証明書ファイルは、デバイスにインストールされます。 デバイスは、SCEP 証明書プロファイルを使用してデバイスによる証明書要求を作成します。
- 証明書プロファイルは、プロファイルを作成するときに使用するプラットフォームを実行しているデバイスのみにインストールされます。
- ユーザー コレクションまたはデバイス コレクションに証明書プロファイルを割り当てることができます。
- デバイス登録後すぐに証明書をデバイスに公開するには、証明書プロファイルをデバイス グループではなくユーザー グループに割り当てます。 デバイス グループに割り当てた場合は、デバイスがポリシーを受け取る前に、デバイスの登録を完全に行う必要があります。
- 各プロファイルは個別に割り当てますが、信頼されたルート CA と、SCEP または PKCS プロファイルを割り当てる必要もあります。 そうしないと、SCEP または PKCS 証明書ポリシーは失敗します。

プロファイルを割り当てる方法については、[デバイス プロファイルを割り当てる方法](device-profile-assign.md)に関する記事をご覧ください。

